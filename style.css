/* ==========================================================================
   Rewritten CSS for Pranav Haridas's Personal Webpage (v2.4 - Applied Fixes)
   Focus: Mobile Fixes, Alignment, Consistency, Accessibility, Performance
   Incorporates fixes for container width, mobile overrides, padding,
   centering, box sizing, transitions, z-index, and image handling.
   ========================================================================== */

/* ==========================================================================
   1. CSS Variables (Theme Configuration)
   ========================================================================== */
:root {
  /* Color Palette */
  --primary-color: #0ea5e9; /* sky-500 */
  --primary-dark: #0369a1; /* sky-700 */
  --primary-light-bg: #e0f2fe; /* sky-100 - Background usage */
  --primary-light-border: #bae6fd; /* sky-200 - Border/Subtle usage */
  --secondary-color: #475569; /* slate-600 */
  --text-color: #1e293b; /* slate-800 */
  --text-muted: #4b5567; /* slate-600 (was gray-600) */
  --text-on-primary: #ffffff;
  --bg-color: #f1f5f9; /* slate-100 */
  --bg-content: #ffffff;
  --bg-muted: #f3f4f6; /* gray-100 */
  --border-color: #e2e8f0; /* slate-200 */
  --border-light: #f3f4f6; /* gray-100 */
  --focus-ring-color: #3b82f6; /* blue-500 */

  /* Dark Mode Colors */
  --dark-primary-color: #38bdf8; /* sky-400 - Brighter for dark */
  --dark-primary-dark: #0ea5e9; /* sky-500 */
  --dark-primary-light-bg: #334155; /* slate-700 - Background usage */
  --dark-primary-light-border: #475569; /* slate-600 - Border/Subtle usage */
  --dark-secondary-color: #94a3b8; /* slate-400 */
  --dark-text-color: #f1f5f9; /* slate-100 */
  --dark-text-muted: #cbd5e1; /* slate-300 */
  --dark-bg-color: #1e293b; /* slate-800 */
  --dark-bg-content: #334155; /* slate-700 */
  --dark-bg-muted: #475569; /* slate-600 */
  --dark-border-color: #475569; /* slate-600 */
  --dark-border-light: #334155; /* slate-700 */
  --dark-focus-ring-color: #60a5fa; /* blue-400 */

  /* Typography */
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
  --font-size-base: clamp(1rem, 0.95rem + 0.25vw, 1.125rem); /* Fluid base size (~16px -> 18px) */
  --line-height-base: 1.6;
  --line-height-relaxed: 1.7;

  /* Spacing & Sizing */
  --header-height-desktop: 4rem; /* 64px */
  --header-height-mobile: 3.5rem; /* 56px - Slightly shorter for mobile */
  --header-height: var(--header-height-desktop); /* Default to desktop height */
  /* FIX 1: Container Width Conflict */
  --container-max-width: 56rem; /* Match content width */
  --content-max-width: 56rem;
  --spacing-unit: 0.25rem; /* 4px */
  --padding-xs: calc(var(--spacing-unit) * 1); /* 0.25rem */
  --padding-sm: calc(var(--spacing-unit) * 2); /* 0.5rem */
  --padding-md: calc(var(--spacing-unit) * 4); /* 1rem */
  --padding-lg: calc(var(--spacing-unit) * 6); /* 1.5rem */
  --padding-xl: calc(var(--spacing-unit) * 8); /* 2rem */
  --padding-xxl: calc(var(--spacing-unit) * 12); /* 3rem */
  /* FIX 3: Padding/Margin Stacking - Define content padding variable */
  --content-padding: var(--padding-xl);

  /* Borders & Shadows */
  --border-radius-sm: 0.25rem;
  --border-radius-md: 0.375rem;
  --border-radius-lg: 0.5rem;
  --border-radius-xl: 0.75rem;
  --border-radius-full: 9999px;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.04); /* Softer */
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.04); /* Softer */
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);

  /* Transitions */
  --transition-duration: 150ms;
  --transition-duration-long: 300ms;
  --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
}

/* ==========================================================================
   2. Dark Mode Variable Overrides
   ========================================================================== */
@media (prefers-color-scheme: dark) {
  :root {
    color-scheme: dark; /* Inform browser about dark mode */

    --primary-color: var(--dark-primary-color);
    --primary-dark: var(--dark-primary-dark);
    --primary-light-bg: var(--dark-primary-light-bg);
    --primary-light-border: var(--dark-primary-light-border);
    --secondary-color: var(--dark-secondary-color);
    --text-color: var(--dark-text-color);
    --text-muted: var(--dark-text-muted);
    --bg-color: var(--dark-bg-color);
    --bg-content: var(--dark-bg-content);
    --bg-muted: var(--dark-bg-muted);
    --border-color: var(--dark-border-color);
    --border-light: var(--dark-border-light);
    --focus-ring-color: var(--dark-focus-ring-color);

    /* Darker Shadows */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.15);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.15);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -4px rgba(0, 0, 0, 0.15);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.15);
  }
}

/* ==========================================================================
   3. Base Styles & Resets
   ========================================================================== */
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  /* FIX 6: Box Sizing Conflict - Separate border properties */
  border: 0;
  border-style: solid;
  border-color: var(--border-color);
}

html {
  scroll-behavior: smooth;
  font-size: var(--font-size-base); /* Apply fluid base font size */
  line-height: var(--line-height-base);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-text-size-adjust: 100%; /* Prevent font scaling in landscape */
}

body {
  font-family: var(--font-sans);
  background-color: var(--bg-color);
  color: var(--text-color);
  /* Use CSS variable for header height offset */
  margin-top: var(--header-height);
  transition: background-color var(--transition-duration-long) ease, color var(--transition-duration-long) ease, margin-top var(--transition-duration) ease; /* Add margin-top transition */
  overflow-x: hidden; /* Prevent accidental horizontal scroll */
}

/* General Link Styling */
a {
  color: var(--primary-color);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: color var(--transition-duration) ease, border-color var(--transition-duration) ease;
  /* Improve tap target slightly for inline links */
  padding-top: var(--padding-xs);
  padding-bottom: var(--padding-xs);
  margin-top: calc(-1 * var(--padding-xs));
  margin-bottom: calc(-1 * var(--padding-xs));
}
a:hover {
  color: var(--primary-dark);
  border-bottom-color: var(--primary-light-border);
}

/* Accessibility focus state (using :focus-visible) */
*:focus { outline: none; } /* Remove default outline */

a:focus-visible,
button:focus-visible,
input:focus-visible,
textarea:focus-visible,
select:focus-visible,
[tabindex]:not([tabindex="-1"]):focus-visible {
  outline: 2px solid var(--focus-ring-color);
  outline-offset: 2px;
  box-shadow: none;
  border-radius: var(--border-radius-sm); /* Optional: add radius to outline */
}

/* Headings with Fluid Typography */
h1, h2, h3, h4, h5, h6 {
  margin-bottom: var(--padding-md);
  font-weight: 600;
  line-height: 1.3;
  color: var(--text-color); /* Explicitly set color */
}
h1 { font-size: clamp(1.75rem, 1.5rem + 1.25vw, 2.5rem); font-weight: 700; } /* Adjusted clamp */
h2 { font-size: clamp(1.375rem, 1.25rem + 0.625vw, 1.75rem); } /* Adjusted clamp */
h3 { font-size: clamp(1.125rem, 1.05rem + 0.375vw, 1.375rem); } /* Adjusted clamp */
h4 { font-size: clamp(1rem, 0.95rem + 0.25vw, 1.125rem); } /* Kept same */

/* Paragraphs */
p {
  margin-bottom: var(--padding-md);
  line-height: var(--line-height-base);
  max-width: 65ch; /* Improve readability */
}
p.leading-relaxed {
  line-height: var(--line-height-relaxed);
  color: var(--text-muted);
}

/* Lists (Basic Reset) */
ul, ol {
  margin-bottom: var(--padding-md);
  padding-left: var(--padding-lg);
}
li {
  margin-bottom: var(--padding-sm);
  padding-left: var(--padding-xs); /* Small indent for list item itself */
}

/* Address */
address {
  font-style: normal;
  line-height: var(--line-height-base);
  color: var(--text-muted);
  margin-bottom: var(--padding-md);
}
address strong {
  color: var(--text-color);
}

/* ==========================================================================
   4. Layout Containers
   ========================================================================== */
.container {
  width: 100%;
  max-width: var(--container-max-width); /* Uses updated variable */
  margin: 0 auto;
  padding: 0 var(--padding-md); /* Mobile-first padding */
}

.main-content-wrapper {
  /* FIX 4: Missing Centering Safeguards */
  width: min(100%, var(--content-max-width));
  margin-inline: auto !important; /* Ensure centering */
  /* Original margin-top/bottom */
  margin-top: var(--padding-xl);
  margin-bottom: var(--padding-xl);
  background-color: var(--bg-content);
  border-radius: var(--border-radius-xl);
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border-color);
  /* FIX 3: Padding/Margin Stacking - Use content padding variable */
  padding: var(--content-padding);
  box-sizing: border-box;
  opacity: 0;
  transform: translateY(10px);
  transition: opacity var(--transition-duration-long) ease,
              transform var(--transition-duration-long) ease,
              background-color var(--transition-duration-long) ease,
              border-color var(--transition-duration-long) ease;
  /* FIX 8: Z-index Conflicts */
  z-index: 10;
  position: relative; /* Needed for z-index to work reliably */
}

/* Desktop overrides for container padding */
@media (min-width: 768px) {
  .container {
    padding: 0; /* Remove mobile padding on desktop */
  }
  /* Note: margin adjustments for main-content-wrapper on desktop were removed
     as they are handled by the base rule now */
}

/* Trigger fade-in */
body.loaded .main-content-wrapper {
  opacity: 1;
  transform: translateY(0);
}

/* ==========================================================================
   5. Header & Navigation (#main-nav) - REFINED
   ========================================================================== */
#main-nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  width: 100%;
  height: var(--header-height); /* Use variable height */
  background-color: hsla(0, 0%, 100%, 0.85);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  /* FIX 8: Z-index Conflicts */
  z-index: 100;
  border-bottom: 1px solid var(--border-light);
  box-shadow: var(--shadow-sm);
  transition: background-color var(--transition-duration) ease,
              border-color var(--transition-duration) ease,
              /* FIX 7: Header Height Transition */
              height 0.3s ease-out;
}
@media (prefers-color-scheme: dark) {
  #main-nav {
    background-color: hsla(215, 28%, 17%, 0.85); /* dark-bg-color equivalent */
  }
}

/* Inner container */
#main-nav .nav-container {
  display: flex;
  justify-content: space-between;
  align-items: center;
  height: 100%;
  /* Use container padding defined globally */
}

/* Site Title */
.site-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text-color);
  letter-spacing: -0.025em;
  transition: color var(--transition-duration) var(--transition-timing);
  text-decoration: none;
  border-bottom: none;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding-right: var(--padding-sm);
  /* Add vertical padding for better tap target */
  padding-top: var(--padding-xs);
  padding-bottom: var(--padding-xs);
  margin-top: calc(-1 * var(--padding-xs));
  margin-bottom: calc(-1 * var(--padding-xs));
}
.site-title:hover {
  color: var(--primary-color);
  border-bottom: none;
}

/* Desktop Navigation Menu */
.nav-menu {
  display: none; /* Hidden by default, shown via media query */
  align-items: center;
  list-style: none;
  padding-left: 0;
  margin-bottom: 0;
  gap: var(--padding-xs);
}
@media (min-width: 768px) { /* md breakpoint */
  .nav-menu {
    display: flex;
  }
}

/* Navigation Links (Desktop & Mobile) */
.nav-link {
  display: block;
  color: var(--text-muted);
  padding: var(--padding-sm) var(--padding-md);
  border-radius: var(--border-radius-md);
  font-size: 0.875rem;
  font-weight: 500;
  text-decoration: none;
  transition: color var(--transition-duration) var(--transition-timing), background-color var(--transition-duration) var(--transition-timing);
  position: relative;
  border-bottom: none;
  white-space: nowrap;
}
.nav-link:hover {
  color: var(--primary-dark);
  background-color: var(--primary-light-bg);
  border-bottom: none;
}
/* Active Navigation Link */
.nav-link.active {
  color: var(--primary-color);
  font-weight: 600;
}
/* Active indicator (Desktop only) */
@media (min-width: 768px) {
  .nav-link.active::before {
      content: '';
      position: absolute;
      bottom: 4px;
      left: var(--padding-md);
      right: var(--padding-md);
      height: 2px;
      background-color: var(--primary-color);
      border-radius: 1px;
      transition: background-color var(--transition-duration) ease;
  }
}


/* Mobile Menu Button */
#mobile-menu-button {
  display: block; /* Display by default, hidden via media query */
  padding: var(--padding-sm);
  border-radius: var(--border-radius-lg);
  color: var(--text-muted);
  background-color: transparent;
  cursor: pointer;
  transition: background-color var(--transition-duration) var(--transition-timing), color var(--transition-duration) var(--transition-timing);
  flex-shrink: 0;
  /* Ensure minimum tap size */
  min-width: 44px;
  min-height: 44px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
#mobile-menu-button:hover {
  background-color: var(--bg-muted);
  color: var(--text-color);
}
/* Focus state handled by global :focus-visible */
@media (min-width: 768px) { /* md breakpoint */
  #mobile-menu-button {
    display: none;
  }
}
/* Icon within the button */
#mobile-menu-button .icon {
  font-size: 1.5rem;
  line-height: 1;
  display: block;
}

/* Mobile Menu Container */
.mobile-menu {
  position: fixed;
  /* Use variable height */
  top: var(--header-height);
  left: 0;
  right: 0;
  background-color: var(--bg-content);
  box-shadow: var(--shadow-lg);
  border-top: 1px solid var(--border-color);
  /* FIX 8: Z-index Conflicts */
  z-index: 90;
  max-height: 0;
  overflow: hidden;
  visibility: hidden;
  transition: max-height 0.3s ease-out,
              visibility 0s linear 0.3s,
              padding 0.3s ease-out,
              border-color var(--transition-duration) ease,
              top var(--transition-duration) ease; /* Add top transition */
  padding: 0 var(--padding-lg);
}
@media (min-width: 768px) { /* md breakpoint */
  .mobile-menu {
    display: none !important;
    max-height: none !important;
    visibility: hidden !important;
  }
}
/* Class to show mobile menu */
.mobile-menu.visible {
  max-height: calc(100vh - var(--header-height));
  visibility: visible;
  transition: max-height 0.3s ease-out, visibility 0s linear 0s, padding 0.3s ease-out, top var(--transition-duration) ease;
  padding: var(--padding-md) var(--padding-lg);
  overflow-y: auto;
}
/* Inner container for mobile menu links */
.mobile-menu > div {
  display: flex;
  flex-direction: column;
  gap: var(--padding-xs);
}
/* Mobile links */
.mobile-menu .nav-link {
    text-align: left;
    padding: var(--padding-md);
    white-space: normal; /* Allow mobile links to wrap */
}
/* Mobile active link - simpler style */
.mobile-menu .nav-link.active {
    background-color: var(--primary-light-bg);
    color: var(--primary-dark); /* Darker color for active */
}


/* ==========================================================================
   6. Page Header
   ========================================================================== */
.page-header {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
  color: var(--text-on-primary);
  padding: var(--padding-xl) var(--padding-lg);
  text-align: center;
  border-bottom: 4px solid var(--primary-dark);
  /* Adjust margin to account for potentially shorter header */
  margin-top: calc(-1 * var(--header-height));
  padding-top: calc(var(--padding-xl) + var(--header-height));
}
.page-header h1 {
  margin-bottom: var(--padding-sm);
  color: var(--text-on-primary);
}
.page-header p {
  font-size: 1.125rem;
  color: var(--text-on-primary);
  font-weight: 300;
  margin-bottom: 0;
  opacity: 0.85;
  max-width: 60ch;
  margin-left: auto;
  margin-right: auto;
}

/* ==========================================================================
   7. Content Sections
   ========================================================================== */
section {
  /* FIX 3: Padding/Margin Stacking - Adjust section padding */
  padding: calc(var(--content-padding) * 0.75) 0;
  border-bottom: 1px solid var(--border-color);
  /* Use variable height for scroll margin */
  scroll-margin-top: calc(var(--header-height) + 1rem);
  transition: border-color var(--transition-duration-long) ease;
}
section:last-child {
  border-bottom: none;
  padding-bottom: var(--padding-xl); /* Keep original bottom padding for last section */
}

/* Section Headings */
section h2 {
  color: var(--primary-dark);
  margin-bottom: var(--padding-lg);
  padding-bottom: var(--padding-sm);
  border-bottom: 2px solid var(--primary-light-border);
  display: inline-block;
}
section h3 {
  color: var(--primary-color);
  margin-top: var(--padding-lg);
  margin-bottom: var(--padding-md);
}

/* ==========================================================================
   8. Styled Lists
   ========================================================================== */
/* Unordered List */
.styled-list {
  list-style: none;
  padding-left: var(--padding-sm);
}
.styled-list li {
  padding-left: var(--padding-lg);
  position: relative;
}
.styled-list li::before {
  content: 'â—†';
  color: var(--primary-color);
  font-size: 0.8em;
  position: absolute;
  left: var(--padding-sm); /* Position relative to padding-left */
  top: 0.3em;
  line-height: 1;
}

/* Ordered List (e.g., Publications) - FIX APPLIED */
.publication-list {
  list-style: none;
  counter-reset: publication-counter;
  padding-left: var(--padding-sm);
}
.publication-list li {
  counter-increment: publication-counter;
  margin-bottom: var(--padding-md);
  /* Adjust padding-left dynamically based on expected number width */
  padding-left: calc(2.5em + var(--padding-md)); /* Base padding for number area */
  position: relative;
}
.publication-list li::before {
  content: counter(publication-counter) ".";
  position: absolute;
  left: 0; /* Align to the very left of the li's padding box */
  top: 0.1em;
  font-weight: 600;
  color: var(--secondary-color);
  text-align: right;
  /* Dynamic width based on content, plus padding */
  width: 2.5em; /* Ensure enough space for 2-3 digits + dot */
  padding-right: var(--padding-md); /* Space between number and text */
  transition: color var(--transition-duration) ease;
}

/* Links within lists */
.publication-list a,
.styled-list a,
.course-list a { /* Assuming .course-list exists */
  word-break: break-word; /* Keep this */
  /* Remove margin/padding adjustments for inline links here, handled globally */
  border-bottom: 1px solid var(--primary-light-border);
}
.publication-list a:hover,
.styled-list a:hover,
.course-list a:hover {
  background-color: var(--primary-light-bg);
  color: var(--primary-dark);
  border-radius: var(--border-radius-sm);
  padding: 0 var(--padding-xs);
  margin: 0 calc(-1 * var(--padding-xs));
  border-bottom-color: transparent;
}

/* ==========================================================================
   9. Forms & Buttons
   ========================================================================== */
.form-group {
  margin-bottom: var(--padding-lg);
}
.form-label {
  display: block;
  margin-bottom: var(--padding-sm);
  font-weight: 500;
  color: var(--text-muted);
  font-size: 0.875rem;
}

input[type="text"],
input[type="email"],
textarea,
select {
  display: block;
  width: 100%;
  padding: var(--padding-sm) var(--padding-md);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius-md);
  background-color: var(--bg-content);
  color: var(--text-color);
  font-size: 1rem; /* Use 1rem for form inputs */
  line-height: var(--line-height-base);
  transition: border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease, background-color var(--transition-duration) ease, color var(--transition-duration) ease;
}
/* Focus state handled by global :focus-visible */
input[type="text"]:focus,
input[type="email"]:focus,
textarea:focus,
select:focus {
   border-color: var(--primary-color);
   /* box-shadow: 0 0 0 2px var(--primary-light-bg); /* Optional inner shadow */
}
textarea {
  min-height: 120px;
  resize: vertical;
}

/* Button Base Style */
.btn {
  display: inline-block;
  padding: var(--padding-sm) var(--padding-lg);
  background-color: var(--primary-color);
  color: var(--text-on-primary);
  border: 1px solid transparent;
  border-radius: var(--border-radius-md);
  font-weight: 500;
  text-align: center;
  cursor: pointer;
  transition: background-color var(--transition-duration) ease, border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease, color var(--transition-duration) ease;
  text-decoration: none;
  line-height: var(--line-height-base);
  font-size: 0.9375rem; /* 15px */
  min-height: 44px; /* Ensure minimum tap height */
  display: inline-flex; /* Align text vertically */
  align-items: center;
  justify-content: center;
}
/* Grouped Button States */
.btn:hover {
  background-color: var(--primary-dark);
  color: var(--text-on-primary);
  box-shadow: var(--shadow-sm); /* Subtle shadow instead of translate */
}
.btn:active {
    background-color: var(--primary-dark); /* Keep dark on active */
    box-shadow: none; /* Remove shadow on active */
}
/* Focus state handled by global :focus-visible */

/* Submit Button (Alias for .btn) */
button[type="submit"],
input[type="submit"] {
  /* Inherit .btn styles */
}

/* ==========================================================================
   10. Footer
   ========================================================================== */
footer {
  background-color: var(--bg-muted);
  color: var(--text-muted);
  text-align: center;
  padding: var(--padding-xl) var(--padding-lg);
  border-top: 1px solid var(--border-color);
  font-size: 0.875rem;
  transition: background-color var(--transition-duration-long) ease, color var(--transition-duration-long) ease, border-color var(--transition-duration-long) ease;
}
footer a {
    color: var(--primary-color);
    font-weight: 500;
    border-bottom: 1px solid transparent;
    /* Tap target improvement */
    padding-top: var(--padding-xs);
    padding-bottom: var(--padding-xs);
    margin-top: calc(-1 * var(--padding-xs));
    margin-bottom: calc(-1 * var(--padding-xs));
}
footer a:hover {
    color: var(--primary-dark);
    border-bottom-color: var(--primary-light-border);
}

/* ==========================================================================
   11. Back-to-Top Button
   ========================================================================== */
.back-to-top {
  position: fixed;
  bottom: var(--padding-lg);
  right: var(--padding-lg);
  background-color: var(--primary-color);
  color: var(--text-on-primary);
  width: 44px; /* Ensure minimum tap size */
  height: 44px;
  border-radius: var(--border-radius-full);
  box-shadow: var(--shadow-md);
  text-decoration: none;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  opacity: 0;
  visibility: hidden;
  transform: scale(0.8); /* Scale transition */
  transition: background-color var(--transition-duration) ease, opacity 0.3s ease, visibility 0s linear 0.3s, transform 0.3s ease, box-shadow var(--transition-duration) ease;
  z-index: 100;
}
.back-to-top.visible {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
    transition-delay: 0s, 0s, 0s, 0s; /* Reset visibility delay */
}
.back-to-top:hover {
  background-color: var(--primary-dark);
  color: var(--text-on-primary);
  transform: scale(1.05); /* Slightly larger on hover */
  box-shadow: var(--shadow-lg);
}
/* Focus state handled by global :focus-visible */

/* ==========================================================================
   12. Utilities
   ========================================================================== */
.flex { display: flex; }
.grid { display: grid; }
.items-center { align-items: center; }
.justify-center { justify-content: center; }
.justify-between { justify-content: space-between; }
.text-center { text-align: center; }
.sr-only { /* Screen reader only */
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}


/* ==========================================================================
   13. MathJax Styling
   ========================================================================== */
.math {
  text-align: center;
  margin: var(--padding-xl) 0;
  overflow-x: auto;
  padding: var(--padding-md);
  background-color: var(--bg-muted); /* Add subtle background */
  border-radius: var(--border-radius-md);
  -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
}

/* ==========================================================================
   14. Responsive Adjustments (Mobile First Refinements)
   ========================================================================== */

/* Note: Media Query Order (Point 5) was interpreted as ensuring correct application
   of overrides within the existing mobile-first structure, rather than moving entire blocks.
   The specific mobile override fix (Point 2) is applied below. */

@media (max-width: 767px) {
  :root {
    --header-height: var(--header-height-mobile);
  }

  .main-content-wrapper {
    /* Original mobile margin adjustment */
    margin-top: var(--padding-xl);
    margin-bottom: var(--padding-xl);
    margin-left: var(--padding-md);
    margin-right: var(--padding-md);
    border-radius: var(--border-radius-lg);
    /* FIX 2: Mobile Override Conflict */
    max-width: 100%; /* Ensure it doesn't exceed viewport */
    width: calc(100% - (2 * var(--padding-md))); /* Account for side margins */
    /* Ensure centering is maintained if needed, though margin handles it */
    margin-inline: auto !important;
  }

  .page-header {
    padding: var(--padding-xl);
    margin-top: calc(-1 * var(--header-height));
    padding-top: calc(var(--padding-xl) + var(--header-height));
  }
}

@media (max-width: 479px) {
  .main-content-wrapper {
    /* Adjust margins for smaller screens */
    margin-top: var(--padding-lg);
    margin-bottom: var(--padding-lg);
    margin-left: var(--padding-sm);
    margin-right: var(--padding-sm);
    border-radius: var(--border-radius-md);
    /* Apply width calculation here too */
    width: calc(100% - (2 * var(--padding-sm)));
    margin-inline: auto !important;
  }

  .page-header {
    padding: var(--padding-lg);
    padding-top: calc(var(--padding-lg) + var(--header-height));
  }
}

/* ==========================================================================
   15. Images (NEW SECTION)
   ========================================================================== */
/* FIX 9: Image Containment */
img {
  max-width: 100%; /* Prevent images from overflowing container */
  height: auto; /* Maintain aspect ratio */
  display: block; /* Remove extra space below inline images */
  margin: 0 auto; /* Center block images if container is wider */
}

